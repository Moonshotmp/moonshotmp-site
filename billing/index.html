<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Billing Portal | Moonshot Medical</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #101921;
      color: #F0EEE9;
      min-height: 100vh;
    }
    .portal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .portal-header h1 {
      font-family: 'Oswald', sans-serif;
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }
    .portal-header .subtitle {
      color: #B2BFBE;
      font-size: 12px;
      margin-top: 2px;
    }
    .header-actions { display: flex; gap: 12px; align-items: center; }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary { background: #B2BFBE; color: #101921; }
    .btn-primary:hover { background: #F0EEE9; }
    .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #B2BFBE; }
    .btn-outline:hover { border-color: #F0EEE9; color: #F0EEE9; }
    .btn-danger { background: rgba(220,53,69,0.15); border: 1px solid rgba(220,53,69,0.3); color: #ff6b6b; }
    .btn-danger:hover { background: rgba(220,53,69,0.25); }
    .btn-sm { padding: 6px 14px; font-size: 11px; }

    .portal-body { max-width: 1100px; margin: 0 auto; padding: 24px; }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 8px;
      padding: 20px;
    }
    .stat-card .label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #B2BFBE;
      margin-bottom: 8px;
    }
    .stat-card .value {
      font-family: 'Oswald', sans-serif;
      font-size: 28px;
      font-weight: 600;
    }

    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 24px;
    }
    .tab {
      padding: 12px 20px;
      font-size: 13px;
      font-weight: 500;
      color: #B2BFBE;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover { color: #F0EEE9; }
    .tab.active { color: #F0EEE9; border-bottom-color: #B2BFBE; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .search-section {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .search-section h2 {
      font-family: 'Oswald', sans-serif;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 16px;
    }
    .search-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 140px auto;
      gap: 12px;
      align-items: end;
    }
    .search-grid.fallback { grid-template-columns: 1fr 1fr auto; }
    .form-group label {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #B2BFBE;
      margin-bottom: 6px;
    }
    .form-group input {
      width: 100%;
      padding: 10px 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      color: #F0EEE9;
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
    }
    .form-group input:focus { outline: none; border-color: rgba(255,255,255,0.3); }
    .form-group input::placeholder { color: rgba(255,255,255,0.3); }

    .results-area { min-height: 100px; }
    .no-results { text-align: center; padding: 40px; color: #B2BFBE; font-size: 14px; }

    .patient-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 12px;
    }
    .patient-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }
    .patient-name {
      font-family: 'Oswald', sans-serif;
      font-size: 18px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .patient-meta { font-size: 13px; color: #B2BFBE; margin-top: 4px; }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .badge-active { background: rgba(40,167,69,0.15); color: #51cf66; border: 1px solid rgba(40,167,69,0.3); }
    .badge-inactive { background: rgba(255,255,255,0.06); color: #B2BFBE; border: 1px solid rgba(255,255,255,0.1); }
    .badge-past_due { background: rgba(255,193,7,0.15); color: #ffd43b; border: 1px solid rgba(255,193,7,0.3); }
    .badge-canceled { background: rgba(220,53,69,0.1); color: #ff6b6b; border: 1px solid rgba(220,53,69,0.25); }
    .patient-detail-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.06);
    }
    .detail-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #B2BFBE;
      margin-bottom: 4px;
    }
    .detail-value {
      font-size: 14px;
      color: #F0EEE9;
    }
    .billing-row {
      display: grid;
      grid-template-columns: 90px 1fr auto;
      gap: 12px;
      font-size: 13px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      align-items: center;
    }
    .billing-row:last-child { border-bottom: none; }
    .pay-status {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 6px;
    }
    .pay-failed { background: rgba(220,53,69,0.2); color: #ff6b6b; }
    .pay-refunded { background: rgba(255,193,7,0.2); color: #ffd43b; }
    .refund-link {
      background: none;
      border: none;
      color: #B2BFBE;
      font-size: 11px;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      margin-left: 8px;
    }
    .refund-link:hover { color: #F0EEE9; }
    .patient-actions { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.06); }

    .members-table { width: 100%; border-collapse: collapse; }
    .members-table th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #B2BFBE;
      text-align: left;
      padding: 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-weight: 500;
    }
    .members-table td {
      padding: 14px;
      font-size: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .members-table tr:hover td { background: rgba(255,255,255,0.02); }

    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: #1a2530;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 32px;
      max-width: 480px;
      width: 90%;
    }
    .modal h2 {
      font-family: 'Oswald', sans-serif;
      font-size: 18px;
      text-transform: uppercase;
      margin-bottom: 20px;
    }
    .modal .form-group { margin-bottom: 14px; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.2);
      border-top-color: #F0EEE9;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 200;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast-success { background: rgba(40,167,69,0.9); color: white; }
    .toast-error { background: rgba(220,53,69,0.9); color: white; }

    @media (max-width: 768px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .search-grid, .search-grid.fallback { grid-template-columns: 1fr; }
      .portal-header { flex-direction: column; gap: 12px; text-align: center; }
      .patient-card-header { flex-direction: column; gap: 8px; }
    }

    /* Cart Modal Styles */
    .cart-modal {
      background: #101921;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      width: 95%;
      max-width: 900px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .cart-header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cart-header h2 {
      font-family: 'Oswald', sans-serif;
      font-size: 20px;
      text-transform: uppercase;
      margin: 0;
    }
    .cart-close {
      background: none;
      border: none;
      color: #B2BFBE;
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
    }
    .cart-close:hover { color: #F0EEE9; }
    .cart-patient {
      padding: 16px 24px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .cart-patient-name {
      font-family: 'Oswald', sans-serif;
      font-size: 16px;
      text-transform: uppercase;
    }
    .cart-patient-meta { font-size: 13px; color: #B2BFBE; margin-top: 2px; }
    .cart-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .cart-products {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      border-right: 1px solid rgba(255,255,255,0.06);
    }
    .cart-sidebar {
      width: 300px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      background: rgba(0,0,0,0.2);
    }
    .category-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .category-tab {
      padding: 8px 16px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      color: #B2BFBE;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .category-tab:hover { border-color: rgba(255,255,255,0.3); color: #F0EEE9; }
    .category-tab.active { background: rgba(178,191,190,0.15); border-color: #B2BFBE; color: #F0EEE9; }
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }
    .product-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .product-card:hover { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); }
    .product-card.in-cart { border-color: #51cf66; background: rgba(40,167,69,0.1); }
    .product-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .product-price {
      font-family: 'Oswald', sans-serif;
      font-size: 18px;
      color: #F0EEE9;
    }
    .product-recurring {
      font-size: 11px;
      color: #B2BFBE;
      margin-top: 2px;
    }
    .cart-items {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 16px;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .cart-item-info { flex: 1; }
    .cart-item-name { font-size: 13px; font-weight: 500; }
    .cart-item-price { font-size: 12px; color: #B2BFBE; }
    .cart-item-qty {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-right: 12px;
    }
    .qty-btn {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      color: #B2BFBE;
      cursor: pointer;
      font-size: 14px;
    }
    .qty-btn:hover { border-color: #F0EEE9; color: #F0EEE9; }
    .cart-item-remove {
      background: none;
      border: none;
      color: #ff6b6b;
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
    }
    .cart-discount {
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .cart-discount label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
    }
    .cart-discount input { width: 16px; height: 16px; cursor: pointer; }
    .cart-totals {
      padding: 16px 0;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .cart-total-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 8px;
    }
    .cart-total-row.grand {
      font-size: 16px;
      font-weight: 600;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .cart-total-row .amount { font-family: 'Oswald', sans-serif; }
    .cart-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .cart-empty {
      text-align: center;
      padding: 40px 20px;
      color: #B2BFBE;
      font-size: 14px;
    }
    .btn-gold {
      background: #c9a227;
      color: #0a0f14;
      font-weight: 600;
    }
    .btn-gold:hover { background: #ddb52f; }
    @media (max-width: 768px) {
      .cart-body { flex-direction: column; }
      .cart-sidebar { width: 100%; border-right: none; border-top: 1px solid rgba(255,255,255,0.06); }
      .cart-products { max-height: 40vh; }
    }
  </style>
</head>
<body>

  <div class="portal-header">
    <div>
      <h1>Billing Portal</h1>
      <div class="subtitle">Moonshot Medical + Performance</div>
    </div>
    <div class="header-actions">
            <button class="btn btn-primary" onclick="openNewPatientModal()">+ New Patient</button>
      <button class="btn btn-outline" onclick="logout()">Log Out</button>
    </div>
  </div>

  <div class="portal-body">
    <div class="tabs">
      <div class="tab active" data-tab="search" onclick="switchTab('search')">Patient Lookup</div>
      <div class="tab" data-tab="members" onclick="switchTab('members')">Active Members</div>
      <div class="tab" data-tab="all" onclick="switchTab('all')">All Members</div>
    </div>

    <!-- Tab: Patient Lookup -->
    <div class="tab-content active" id="tab-search">
      <div class="search-section">
        <h2>Find Patient</h2>
        <form id="searchForm" onsubmit="searchPatient(event)">
          <div class="search-grid">
            <div class="form-group">
              <label for="searchFirst">First Name</label>
              <input type="text" id="searchFirst" placeholder="First name">
            </div>
            <div class="form-group">
              <label for="searchLast">Last Name</label>
              <input type="text" id="searchLast" placeholder="Last name">
            </div>
            <div class="form-group">
              <label for="searchDob">Date of Birth</label>
              <input type="text" id="searchDob" placeholder="MM/DD/YYYY" maxlength="10" inputmode="numeric">
            </div>
            <button type="submit" class="btn btn-primary" id="searchBtn">Search</button>
          </div>
        </form>
        <details style="margin-top: 12px;">
          <summary style="color: #B2BFBE; font-size: 12px; cursor: pointer;">Fallback: Search by email or phone</summary>
          <form id="fallbackForm" onsubmit="searchPatientFallback(event)" style="margin-top: 12px;">
            <div class="search-grid fallback">
              <div class="form-group">
                <label for="searchEmail">Email</label>
                <input type="email" id="searchEmail" placeholder="patient@email.com">
              </div>
              <div class="form-group">
                <label for="searchPhone">Phone</label>
                <input type="tel" id="searchPhone" placeholder="(555) 555-5555">
              </div>
              <button type="submit" class="btn btn-primary">Search</button>
            </div>
          </form>
        </details>
      </div>
      <div class="results-area" id="searchResults">
        <div class="no-results">Search for a patient above to get started</div>
      </div>
    </div>

    <!-- Tab: Active Members -->
    <div class="tab-content" id="tab-members">
      <div id="activeMembersList"></div>
    </div>

    <!-- Tab: All Members -->
    <div class="tab-content" id="tab-all">
      <div id="allMembersList"></div>
    </div>
  </div>

  <!-- New Patient Modal -->
  <div class="modal-overlay" id="newPatientModal">
    <div class="modal">
      <h2>Add New Patient</h2>
      <form id="newPatientForm" onsubmit="createPatient(event)">
        <div class="form-group">
          <label>First Name *</label>
          <input type="text" id="npFirst" required>
        </div>
        <div class="form-group">
          <label>Last Name *</label>
          <input type="text" id="npLast" required>
        </div>
        <div class="form-group">
          <label>Date of Birth *</label>
          <input type="text" id="npDob" placeholder="MM/DD/YYYY" maxlength="10" inputmode="numeric" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="npEmail">
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="npPhone">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('newPatientModal')">Cancel</button>
          <button type="submit" class="btn btn-primary" id="npSubmitBtn">Add Patient</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Refund Modal -->
  <div class="modal-overlay" id="refundModal">
    <div class="modal">
      <h2>Issue Refund</h2>
      <div id="refundDetails" style="margin-bottom:16px;padding:12px;background:rgba(255,255,255,0.04);border-radius:6px;"></div>
      <form id="refundForm" onsubmit="processRefund(event)">
        <input type="hidden" id="refundPaymentId">
        <input type="hidden" id="refundStripeId">
        <input type="hidden" id="refundInvoiceId">
        <input type="hidden" id="refundMaxAmount">
        <div class="form-group">
          <label>Refund Amount ($)</label>
          <input type="number" id="refundAmount" step="0.01" min="0.01" required placeholder="Enter amount">
          <div style="font-size:12px;color:#B2BFBE;margin-top:4px;">Leave blank or enter full amount for complete refund</div>
        </div>
        <div class="form-group">
          <label>Reason (optional)</label>
          <input type="text" id="refundReason" placeholder="e.g., Customer request">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" onclick="closeModal('refundModal')">Cancel</button>
          <button type="submit" class="btn btn-danger" id="refundSubmitBtn">Process Refund</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cart Modal -->
  <div class="modal-overlay" id="cartModal">
    <div class="cart-modal">
      <div class="cart-header">
        <h2>New Charge</h2>
        <button class="cart-close" onclick="closeCartModal()">&times;</button>
      </div>
      <div class="cart-patient" id="cartPatientInfo"></div>
      <div class="cart-body">
        <div class="cart-products">
          <div class="category-tabs" id="categoryTabs"></div>
          <div class="products-grid" id="productsGrid"></div>
        </div>
        <div class="cart-sidebar">
          <div style="font-size:12px;text-transform:uppercase;letter-spacing:0.05em;color:#B2BFBE;margin-bottom:12px;">Cart</div>
          <div class="cart-items" id="cartItems">
            <div class="cart-empty">Add items to get started</div>
          </div>
          <div class="cart-discount">
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="text" id="discountCode" placeholder="Discount code"
                style="flex:1;padding:8px 10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:4px;color:#F0EEE9;font-size:13px;">
              <button type="button" onclick="applyDiscountCode()" class="btn btn-sm btn-outline" style="padding:8px 12px;">Apply</button>
            </div>
            <div id="discountStatus" style="font-size:11px;margin-top:6px;color:#B2BFBE;"></div>
          </div>
          <div class="cart-totals" id="cartTotals">
            <div class="cart-total-row">
              <span>Recurring (monthly)</span>
              <span class="amount" id="totalRecurring">$0</span>
            </div>
            <div class="cart-total-row">
              <span>One-time</span>
              <span class="amount" id="totalOneTime">$0</span>
            </div>
            <div class="cart-total-row grand">
              <span>Total Today</span>
              <span class="amount" id="totalGrand">$0</span>
            </div>
          </div>
          <div class="cart-actions">
            <button class="btn btn-gold" id="checkoutCardBtn" onclick="checkoutWithCard()" disabled>Enter Card to Pay</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Card Entry Modal -->
  <div class="modal-overlay" id="cardEntryModal">
    <div class="modal">
      <h2>Enter Payment Card</h2>
      <div id="cartSummaryForCard" style="margin-bottom:16px;padding:12px;background:rgba(255,255,255,0.04);border-radius:6px;font-size:13px;"></div>
      <div class="form-group">
        <label>Card Details</label>
        <div id="card-element" style="padding:14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;"></div>
        <div id="card-errors" style="color:#ff6b6b;font-size:12px;margin-top:8px;"></div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" onclick="closeCardEntryModal()">Cancel</button>
        <button type="button" class="btn btn-gold" id="processPaymentBtn" onclick="processCartPayment()">Process Payment</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
    const API = '/.netlify/functions';
    let token = localStorage.getItem('ms_membership_token');

    // Auth guard
    if (!token) {
      window.location.href = '/billing/login.html';
    } else {
      fetch(`${API}/admin-verify`, {
        headers: { 'Authorization': `Bearer ${token}` }
      }).then(res => {
        if (!res.ok) {
          localStorage.removeItem('ms_membership_token');
          window.location.href = '/billing/login.html';
        }
      }).catch(() => {
        window.location.href = '/billing/login.html';
      });
    }

    function authHeaders() {
      return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
    }

    function logout() {
      localStorage.removeItem('ms_membership_token');
      window.location.href = '/billing/login.html';
    }

    function showToast(msg, type = 'success') {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.className = `toast toast-${type} show`;
      setTimeout(() => el.classList.remove('show'), 3000);
    }

    // Date input auto-formatting (MM/DD/YYYY)
    function setupDateInput(input) {
      input.addEventListener('input', function(e) {
        let v = this.value.replace(/\D/g, '');
        if (v.length >= 2) v = v.slice(0,2) + '/' + v.slice(2);
        if (v.length >= 5) v = v.slice(0,5) + '/' + v.slice(5,9);
        this.value = v;
      });
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && this.value.endsWith('/')) {
          e.preventDefault();
          this.value = this.value.slice(0, -1);
        }
      });
    }
    // Convert MM/DD/YYYY to YYYY-MM-DD for API
    function toIsoDate(mmddyyyy) {
      if (!mmddyyyy) return '';
      const parts = mmddyyyy.split('/');
      if (parts.length !== 3) return mmddyyyy;
      return `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
    }
    // Convert YYYY-MM-DD to MM/DD/YYYY for display
    function fromIsoDate(isoDate) {
      if (!isoDate) return '';
      const parts = isoDate.split('-');
      if (parts.length !== 3) return isoDate;
      return `${parts[1]}/${parts[2]}/${parts[0]}`;
    }
    // Setup date inputs on load
    document.addEventListener('DOMContentLoaded', () => {
      setupDateInput(document.getElementById('searchDob'));
      setupDateInput(document.getElementById('npDob'));
    });

    function openNewPatientModal() {
      document.getElementById('newPatientModal').classList.add('show');
    }
    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }

    // Close modal on overlay click
    document.getElementById('newPatientModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal('newPatientModal');
    });
    document.getElementById('refundModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal('refundModal');
    });

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
      if (tab === 'members') loadMembers('active');
      if (tab === 'all') loadMembers('all');
    }

    // Search
    async function searchPatient(e) {
      e.preventDefault();
      const first = document.getElementById('searchFirst').value.trim();
      const last = document.getElementById('searchLast').value.trim();
      const dob = toIsoDate(document.getElementById('searchDob').value);
      if (!first && !last) { showToast('Enter at least a name', 'error'); return; }

      document.getElementById('searchResults').innerHTML = '<div class="no-results"><span class="spinner"></span></div>';
      try {
        const res = await fetch(`${API}/membership-patient-search`, {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ first_name: first, last_name: last, dob: dob || undefined })
        });
        const data = await res.json();
        renderSearchResults(data.patients || []);
      } catch (err) { showToast('Search failed: ' + err.message, 'error'); }
    }

    async function searchPatientFallback(e) {
      e.preventDefault();
      const email = document.getElementById('searchEmail').value.trim();
      const phone = document.getElementById('searchPhone').value.trim();
      if (!email && !phone) { showToast('Enter email or phone', 'error'); return; }

      document.getElementById('searchResults').innerHTML = '<div class="no-results"><span class="spinner"></span></div>';
      try {
        const res = await fetch(`${API}/membership-patient-search`, {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ email, phone })
        });
        const data = await res.json();
        renderSearchResults(data.patients || []);
      } catch (err) { showToast('Search failed: ' + err.message, 'error'); }
    }

    function renderSearchResults(patients) {
      const el = document.getElementById('searchResults');
      if (!patients.length) {
        el.innerHTML = '<div class="no-results">No patients found. Add a new patient using the button above.</div>';
        return;
      }
      el.innerHTML = patients.map(p => {
        const activeMem = (p.memberships || []).find(m => m.status === 'active');
        const pastDue = (p.memberships || []).find(m => m.status === 'past_due');
        const mem = activeMem || pastDue || (p.memberships || []).find(m => m.status === 'canceled');
        const statusClass = mem ? mem.status : 'inactive';
        const statusLabel = mem ? mem.status.replace('_', ' ') : 'No Membership';

        // Format membership info with next billing date
        let membershipInfo = '';
        if (mem) {
          const startDate = new Date(mem.current_period_start || mem.created_at).toLocaleDateString();
          const amount = (mem.amount_cents / 100).toFixed(2);
          const planLabel = mem.plan_type?.includes('family') ? 'Family Plan' : 'Standard';
          const nextBilling = mem.current_period_end ? new Date(mem.current_period_end).toLocaleDateString() : 'N/A';
          membershipInfo = `
            <div class="patient-detail-section">
              <div class="detail-label">Membership</div>
              <div class="detail-value">$${amount}/mo (${planLabel}) &middot; Started ${startDate}</div>
              ${mem.status === 'active' ? `<div class="detail-value" style="margin-top:4px;font-size:13px;color:#B2BFBE;">Next billing: ${nextBilling}</div>` : ''}
            </div>`;
        }

        // Format ALL payments (billing history)
        const payments = (p.payments || []).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        let paymentsInfo = '';
        if (payments.length > 0) {
          const paymentsList = payments.map(pay => {
            const date = new Date(pay.created_at).toLocaleDateString();
            const amount = (pay.amount_cents / 100).toFixed(2);
            const desc = pay.description || pay.type || 'Payment';
            const isFailed = pay.status === 'failed';
            const isRefunded = pay.status === 'refunded';
            const statusStyle = isFailed ? 'color:#ff6b6b;' : isRefunded ? 'color:#ffd43b;' : '';
            const statusBadge = isFailed ? '<span class="pay-status pay-failed">FAILED</span>' :
                               isRefunded ? '<span class="pay-status pay-refunded">REFUNDED</span>' : '';
            const canRefund = pay.status === 'succeeded' && (pay.stripe_payment_intent_id || pay.stripe_invoice_id);
            const refundBtn = canRefund
              ? `<button class="refund-link" onclick="openRefundModal('${pay.id}', '${pay.stripe_payment_intent_id || ''}', '${pay.stripe_invoice_id || ''}', ${pay.amount_cents}, '${esc(desc)}')">Refund</button>`
              : '';
            return `<div class="billing-row" style="${statusStyle}">
              <span>${date}</span>
              <span>${esc(desc)} ${statusBadge}</span>
              <span><strong>$${amount}</strong> ${refundBtn}</span>
            </div>`;
          }).join('');
          paymentsInfo = `
            <div class="patient-detail-section">
              <div class="detail-label">Billing History</div>
              ${paymentsList}
            </div>`;
        }

        // Contact info
        let contactInfo = '';
        if (p.email || p.phone) {
          contactInfo = `
            <div class="patient-detail-section">
              <div class="detail-label">Contact</div>
              <div class="detail-value">
                ${p.email ? `<a href="mailto:${esc(p.email)}" style="color:#B2BFBE;">${esc(p.email)}</a>` : ''}
                ${p.email && p.phone ? ' &middot; ' : ''}
                ${p.phone ? `<a href="tel:${p.phone}" style="color:#B2BFBE;">${formatPhone(p.phone)}</a>` : ''}
              </div>
            </div>`;
        }

        return `
          <div class="patient-card">
            <div class="patient-card-header">
              <div>
                <div class="patient-name">${esc(p.first_name)} ${esc(p.last_name)}</div>
                <div class="patient-meta">DOB: ${formatDob(p.dob)}</div>
              </div>
              <span class="badge badge-${statusClass}">${statusLabel}</span>
            </div>
            ${contactInfo}
            ${membershipInfo}
            ${paymentsInfo}
            <div class="patient-actions">
              <button class="btn btn-gold btn-sm" onclick="openCartModal('${p.id}', '${esc(p.first_name)}', '${esc(p.last_name)}', '${formatDob(p.dob)}')">New Charge</button>
              ${activeMem ? `<button class="btn btn-danger btn-sm" onclick="cancelMembership('${activeMem.id}', '${esc(p.first_name)} ${esc(p.last_name)}')">Cancel Membership</button>` : ''}
            </div>
          </div>`;
      }).join('');
    }

    function formatDob(dob) {
      if (!dob) return '';
      const parts = dob.split('-');
      if (parts.length !== 3) return dob;
      return `${parts[1]}/${parts[2]}/${parts[0]}`;
    }

    function esc(str) {
      const d = document.createElement('div');
      d.textContent = str || '';
      return d.innerHTML;
    }

    function formatPhone(phone) {
      if (!phone || phone.length !== 10) return phone || '';
      return `(${phone.slice(0,3)}) ${phone.slice(3,6)}-${phone.slice(6)}`;
    }

    // Refund functions
    function openRefundModal(paymentId, stripeId, invoiceId, amountCents, description) {
      const maxAmount = (amountCents / 100).toFixed(2);
      document.getElementById('refundPaymentId').value = paymentId;
      document.getElementById('refundStripeId').value = stripeId || '';
      document.getElementById('refundInvoiceId').value = invoiceId || '';
      document.getElementById('refundMaxAmount').value = maxAmount;
      document.getElementById('refundAmount').value = maxAmount;
      document.getElementById('refundAmount').max = maxAmount;
      document.getElementById('refundDetails').innerHTML = `
        <div style="font-size:14px;"><strong>${description}</strong></div>
        <div style="font-size:13px;color:#B2BFBE;margin-top:4px;">Original amount: $${maxAmount}</div>
      `;
      document.getElementById('refundModal').classList.add('show');
    }

    async function processRefund(e) {
      e.preventDefault();
      const btn = document.getElementById('refundSubmitBtn');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      const paymentId = document.getElementById('refundPaymentId').value;
      const stripeId = document.getElementById('refundStripeId').value;
      const invoiceId = document.getElementById('refundInvoiceId').value;
      const amount = parseFloat(document.getElementById('refundAmount').value);
      const reason = document.getElementById('refundReason').value;

      try {
        const res = await fetch(`${API}/membership-refund`, {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({
            payment_id: paymentId,
            payment_intent_id: stripeId || undefined,
            invoice_id: invoiceId || undefined,
            amount_dollars: amount,
            reason: reason || undefined,
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);

        closeModal('refundModal');
        showToast(`Refunded $${amount.toFixed(2)} successfully`);
        document.getElementById('refundForm').reset();
        // Re-run search to refresh data
        document.getElementById('searchForm').dispatchEvent(new Event('submit'));
      } catch (err) {
        showToast(err.message || 'Refund failed', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Process Refund';
      }
    }

    // Create patient
    async function createPatient(e) {
      e.preventDefault();
      const btn = document.getElementById('npSubmitBtn');
      btn.disabled = true; btn.textContent = 'Saving...';
      try {
        const res = await fetch(`${API}/membership-create-patient`, {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({
            first_name: document.getElementById('npFirst').value,
            last_name: document.getElementById('npLast').value,
            dob: toIsoDate(document.getElementById('npDob').value),
            email: document.getElementById('npEmail').value,
            phone: document.getElementById('npPhone').value,
          })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        closeModal('newPatientModal');
        showToast('Patient added');
        document.getElementById('newPatientForm').reset();
        document.getElementById('searchFirst').value = data.patient.first_name;
        document.getElementById('searchLast').value = data.patient.last_name;
        document.getElementById('searchDob').value = fromIsoDate(data.patient.dob);
        renderSearchResults([{ ...data.patient, memberships: [], payments: [] }]);
      } catch (err) {
        showToast(err.message || 'Failed to create patient', 'error');
      } finally {
        btn.disabled = false; btn.textContent = 'Add Patient';
      }
    }

    function goToCheckout(patientId, type) {
      window.location.href = `/billing/checkout.html?patient=${patientId}&type=${type}`;
    }

    async function cancelMembership(membershipId, patientName) {
      if (!confirm(`Cancel membership for ${patientName}? This will stop future billing.`)) return;
      try {
        const res = await fetch(`${API}/membership-cancel`, {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ membership_id: membershipId })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        showToast('Membership canceled');
        document.getElementById('searchForm').dispatchEvent(new Event('submit'));
      } catch (err) { showToast(err.message || 'Cancel failed', 'error'); }
    }

    // Members list
    async function loadMembers(status) {
      const containerId = status === 'active' ? 'activeMembersList' : 'allMembersList';
      const el = document.getElementById(containerId);
      el.innerHTML = '<div class="no-results"><span class="spinner"></span></div>';
      try {
        const res = await fetch(`${API}/membership-list?status=${status}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        renderMembersTable(el, data.memberships || []);
      } catch (err) {
        el.innerHTML = `<div class="no-results">Failed to load: ${err.message}</div>`;
      }
    }

    function renderMembersTable(el, memberships) {
      console.log('Rendering memberships:', memberships);
      if (!memberships.length) { el.innerHTML = '<div class="no-results">No memberships found</div>'; return; }
      el.innerHTML = `
        <table class="members-table">
          <thead><tr>
            <th>Patient</th><th>Plan</th><th>Status</th><th>Started</th><th>Actions</th>
          </tr></thead>
          <tbody>${memberships.map(m => {
            const p = m.patients;
            const patientId = p?.id || m.patient_id || '';
            console.log('Patient data:', p, 'Using ID:', patientId);
            return `<tr>
              <td>
                <a href="#" onclick="viewPatientDetails('${patientId}'); return false;" style="color:#F0EEE9;text-decoration:none;">
                  <strong>${esc(p?.first_name || '')} ${esc(p?.last_name || '')}</strong>
                </a>
                <div style="font-size:12px;color:#B2BFBE;">${esc(p?.email || '')}</div>
              </td>
              <td>HRT $${(m.amount_cents / 100).toFixed(0)}/mo</td>
              <td><span class="badge badge-${m.status}">${m.status.replace('_', ' ')}</span></td>
              <td style="font-size:13px;">${new Date(m.created_at).toLocaleDateString()}</td>
              <td>${m.status === 'active' ? `<button class="btn btn-danger btn-sm" onclick="cancelMembership('${m.id}', '${esc(p?.first_name)} ${esc(p?.last_name)}')">Cancel</button>` : ''}</td>
            </tr>`;
          }).join('')}</tbody>
        </table>`;
    }

    // View patient details - switch to search tab and show patient
    async function viewPatientDetails(patientId) {
      console.log('viewPatientDetails called with:', patientId);
      if (!patientId || patientId === 'undefined' || patientId === 'null') {
        console.error('Invalid patient ID');
        showToast('Could not load patient details', 'error');
        return;
      }
      switchTab('search');
      document.getElementById('searchResults').innerHTML = '<div class="no-results"><span class="spinner"></span></div>';
      try {
        const res = await fetch(`${API}/membership-patient-search`, {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify({ patient_id: patientId })
        });
        const data = await res.json();
        renderSearchResults(data.patients || []);
      } catch (err) {
        showToast('Failed to load patient: ' + err.message, 'error');
      }
    }

    // ===== CART FUNCTIONALITY =====
    let cart = [];
    let products = [];
    let categories = [];
    let discounts = [];
    let appliedDiscount = null;
    let currentPatientId = null;
    let currentCategory = 'test';
    let stripe = null;
    let cardElement = null;

    // Initialize Stripe
    document.addEventListener('DOMContentLoaded', async () => {
      // Load products on page load
      await loadProducts();
    });

    async function loadProducts() {
      try {
        // Add cache-busting parameter to prevent Safari caching issues
        const cacheBust = Date.now();
        const res = await fetch(`${API}/billing-products?_=${cacheBust}`, {
          cache: 'no-store',
          headers: { 'Cache-Control': 'no-cache' }
        });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();
        products = data.products || [];
        categories = data.categories || [];
        discounts = data.discounts || [];
        console.log('Products loaded:', products.length);
      } catch (err) {
        console.error('Failed to load products:', err);
        showToast('Failed to load products. Please refresh.', 'error');
      }
    }

    function applyDiscountCode() {
      const codeInput = document.getElementById('discountCode');
      const statusEl = document.getElementById('discountStatus');
      const code = codeInput.value.trim().toLowerCase();

      if (!code) {
        appliedDiscount = null;
        statusEl.textContent = '';
        statusEl.style.color = '#B2BFBE';
        updateCartTotals();
        return;
      }

      const discount = discounts.find(d => d.code.toLowerCase() === code);
      if (discount) {
        appliedDiscount = discount;
        statusEl.textContent = `${discount.percent}% discount applied to ${discount.appliesToRecurring ? 'memberships' : 'one-time items'}`;
        statusEl.style.color = '#51cf66';
      } else {
        appliedDiscount = null;
        statusEl.textContent = 'Invalid discount code';
        statusEl.style.color = '#ff6b6b';
      }
      updateCartTotals();
    }

    function openCartModal(patientId, firstName, lastName, dob) {
      currentPatientId = patientId;
      cart = [];
      currentCategory = 'test';
      appliedDiscount = null;
      document.getElementById('discountCode').value = '';
      document.getElementById('discountStatus').textContent = '';

      // Set patient info
      document.getElementById('cartPatientInfo').innerHTML = `
        <div class="cart-patient-name">${esc(firstName)} ${esc(lastName)}</div>
        <div class="cart-patient-meta">DOB: ${dob}</div>
      `;

      renderCategoryTabs();
      renderProducts();
      renderCartItems();
      updateCartTotals();

      document.getElementById('cartModal').classList.add('show');
    }

    function closeCartModal() {
      document.getElementById('cartModal').classList.remove('show');
      cart = [];
      currentPatientId = null;
    }

    function renderCategoryTabs() {
      const container = document.getElementById('categoryTabs');
      container.innerHTML = categories.map(cat => `
        <button class="category-tab ${cat.id === currentCategory ? 'active' : ''}"
                onclick="selectCategory('${cat.id}')">
          ${esc(cat.name)}
        </button>
      `).join('');
    }

    function selectCategory(catId) {
      currentCategory = catId;
      renderCategoryTabs();
      renderProducts();
    }

    function renderProducts() {
      const container = document.getElementById('productsGrid');
      const filtered = products.filter(p => p.categoryId === currentCategory || p.category === currentCategory);

      if (filtered.length === 0) {
        container.innerHTML = '<div class="cart-empty">No products in this category</div>';
        return;
      }

      container.innerHTML = filtered.map(p => {
        const inCart = cart.some(c => c.code === p.code);
        const priceDisplay = (p.price / 100).toFixed(2);
        return `
          <div class="product-card ${inCart ? 'in-cart' : ''}" onclick="addToCart('${p.code}')">
            <div class="product-name">${esc(p.name)}</div>
            <div class="product-price">$${priceDisplay}</div>
            ${p.recurring ? '<div class="product-recurring">/month</div>' : ''}
          </div>
        `;
      }).join('');
    }

    function addToCart(code) {
      const product = products.find(p => p.code === code);
      if (!product) return;

      const existing = cart.find(c => c.code === code);
      if (existing) {
        // For recurring items, don't allow multiples
        if (product.recurring) return;
        existing.quantity++;
      } else {
        cart.push({ code, quantity: 1 });
      }

      renderProducts();
      renderCartItems();
      updateCartTotals();
    }

    function removeFromCart(code) {
      cart = cart.filter(c => c.code !== code);
      renderProducts();
      renderCartItems();
      updateCartTotals();
    }

    function changeQuantity(code, delta) {
      const item = cart.find(c => c.code === code);
      if (!item) return;

      item.quantity += delta;
      if (item.quantity < 1) {
        removeFromCart(code);
        return;
      }

      renderCartItems();
      updateCartTotals();
    }

    function renderCartItems() {
      const container = document.getElementById('cartItems');
      if (cart.length === 0) {
        container.innerHTML = '<div class="cart-empty">Add items to get started</div>';
        return;
      }

      container.innerHTML = cart.map(item => {
        const product = products.find(p => p.code === item.code);
        if (!product) return '';

        const unitPrice = (product.price / 100).toFixed(2);
        const lineTotal = ((product.price * item.quantity) / 100).toFixed(2);

        return `
          <div class="cart-item">
            <div class="cart-item-info">
              <div class="cart-item-name">${esc(product.name)}</div>
              <div class="cart-item-price">$${unitPrice}${product.recurring ? '/mo' : ''}</div>
            </div>
            ${!product.recurring ? `
              <div class="cart-item-qty">
                <button class="qty-btn" onclick="changeQuantity('${item.code}', -1)">&minus;</button>
                <span>${item.quantity}</span>
                <button class="qty-btn" onclick="changeQuantity('${item.code}', 1)">+</button>
              </div>
            ` : ''}
            <button class="cart-item-remove" onclick="removeFromCart('${item.code}')">&times;</button>
          </div>
        `;
      }).join('');
    }

    function updateCartTotals() {
      let recurringTotal = 0;
      let oneTimeTotal = 0;
      let totalDiscount = 0;

      cart.forEach(item => {
        const product = products.find(p => p.code === item.code);
        if (!product) return;

        const amount = product.price * item.quantity;

        if (product.recurring) {
          if (appliedDiscount && appliedDiscount.appliesToRecurring) {
            const discount = Math.round(amount * (appliedDiscount.percent / 100));
            totalDiscount += discount;
            recurringTotal += (amount - discount);
          } else {
            recurringTotal += amount;
          }
        } else {
          if (appliedDiscount && appliedDiscount.appliesToOneTime) {
            const discount = Math.round(amount * (appliedDiscount.percent / 100));
            totalDiscount += discount;
            oneTimeTotal += (amount - discount);
          } else {
            oneTimeTotal += amount;
          }
        }
      });

      const grandTotal = recurringTotal + oneTimeTotal;

      document.getElementById('totalRecurring').textContent = '$' + (recurringTotal / 100).toFixed(2);
      document.getElementById('totalOneTime').textContent = '$' + (oneTimeTotal / 100).toFixed(2);
      document.getElementById('totalGrand').textContent = '$' + (grandTotal / 100).toFixed(2);

      // Enable/disable checkout button
      document.getElementById('checkoutCardBtn').disabled = grandTotal === 0;
    }

    async function checkoutWithCard() {
      if (cart.length === 0) return;

      // Show summary in card entry modal
      let summaryHtml = '<strong>Items:</strong><br>';
      cart.forEach(item => {
        const product = products.find(p => p.code === item.code);
        if (!product) return;
        summaryHtml += `${esc(product.name)} x${item.quantity}<br>`;
      });
      if (appliedDiscount) {
        summaryHtml += `<br><em>${appliedDiscount.percent}% discount applied</em>`;
      }
      summaryHtml += `<br><br><strong>Total: ${document.getElementById('totalGrand').textContent}</strong>`;
      document.getElementById('cartSummaryForCard').innerHTML = summaryHtml;

      // Initialize Stripe if not already
      if (!stripe) {
        const res = await fetch(`${API}/membership-config`);
        const data = await res.json();
        if (!data.stripe_publishable_key) {
          throw new Error('Stripe not configured');
        }
        stripe = Stripe(data.stripe_publishable_key);
      }

      // Mount card element
      const elements = stripe.elements();
      if (cardElement) {
        cardElement.destroy();
      }
      cardElement = elements.create('card', {
        style: {
          base: {
            color: '#F0EEE9',
            fontFamily: 'Poppins, sans-serif',
            fontSize: '16px',
            '::placeholder': { color: 'rgba(255,255,255,0.4)' }
          },
          invalid: { color: '#ff6b6b' }
        }
      });
      cardElement.mount('#card-element');
      cardElement.on('change', (event) => {
        document.getElementById('card-errors').textContent = event.error ? event.error.message : '';
      });

      document.getElementById('cardEntryModal').classList.add('show');
    }

    function closeCardEntryModal() {
      document.getElementById('cardEntryModal').classList.remove('show');
      if (cardElement) {
        cardElement.destroy();
        cardElement = null;
      }
    }

    async function processCartPayment() {
      const btn = document.getElementById('processPaymentBtn');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
        // Create SetupIntent to collect payment method
        const setupRes = await fetch(`${API}/membership-setup-intent`, {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({ patient_id: currentPatientId })
        });
        const setupData = await setupRes.json();
        if (!setupRes.ok) throw new Error(setupData.error);

        // Confirm card setup
        const { setupIntent, error } = await stripe.confirmCardSetup(setupData.client_secret, {
          payment_method: { card: cardElement }
        });
        if (error) throw new Error(error.message);

        // Process cart checkout with payment method
        const cartData = cart.map(item => ({ code: item.code, quantity: item.quantity }));

        const checkoutRes = await fetch(`${API}/billing-cart-checkout`, {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({
            patient_id: currentPatientId,
            payment_method_id: setupIntent.payment_method,
            cart: cartData,
            discount_code: appliedDiscount ? appliedDiscount.code : null
          })
        });
        const checkoutData = await checkoutRes.json();
        if (!checkoutRes.ok) throw new Error(checkoutData.error);

        // Success!
        closeCardEntryModal();
        closeCartModal();

        // Build success message
        let msg = 'Payment successful!';
        if (checkoutData.subscriptions?.length > 0) {
          msg += ` ${checkoutData.subscriptions.length} subscription(s) created.`;
        }
        if (checkoutData.payments?.length > 0) {
          msg += ` $${(checkoutData.totals.oneTimeTotal / 100).toFixed(2)} charged for one-time items.`;
        }
        showToast(msg);

        // Refresh patient data
        document.getElementById('searchForm').dispatchEvent(new Event('submit'));

      } catch (err) {
        document.getElementById('card-errors').textContent = err.message;
        showToast(err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Process Payment';
      }
    }

    // Close cart modal on overlay click
    document.getElementById('cartModal').addEventListener('click', function(e) {
      if (e.target === this) closeCartModal();
    });
    document.getElementById('cardEntryModal').addEventListener('click', function(e) {
      if (e.target === this) closeCardEntryModal();
    });

  </script>
</body>
</html>
