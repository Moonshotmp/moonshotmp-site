<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="canonical" href="https://moonshotmp.com/partners/setup.html" />
  <title>Partner Store Setup</title>
  <link rel="stylesheet" href="/partners/styles.css" />
</head>
<body>
  <section class="section section-dark bg-texture">
    <div class="container" style="max-width: 720px;">
      <h1>Partner Store Setup</h1>
      <p class="lead">Create your partner storefront first. Stripe connection happens on the next step.</p>

      <form id="partner-form" class="card" style="padding: 1.5rem;">
        <label>
          Partner name
          <input id="name" name="name" placeholder="e.g. Acme Co" required />
        </label>

        <label>
          Contact email
          <input id="email" name="email" type="email" placeholder="name@acme.com" />
        </label>

        <div class="muted" style="margin-top: 0.75rem;">
          Logo upload happens after you sign in (magic link) on the Manage Store page.
        </div>

        <div style="margin-top: 1rem; opacity: 0.9;">
          Store link: <span id="store-link-preview"></span>
        </div>

        <div style="display:flex; gap: 10px; margin-top: 1.25rem; align-items:center;">
          <button type="submit" class="btn-primary">Create Store</button>
          <a id="go-connect" class="btn-outline" href="#" style="display:none;">Continue to Stripe</a>
        </div>

        <pre id="status" style="white-space:pre-wrap;margin-top:16px;"></pre>
      </form>
    </div>
  </section>

  <script>
    const statusEl = document.getElementById("status");
    const nameEl = document.getElementById("name");
    const emailEl = document.getElementById("email");
    const linkPreviewEl = document.getElementById("store-link-preview");
    const goConnectEl = document.getElementById("go-connect");

    function setStatus(msg) { statusEl.textContent = msg; }

    function slugify(input) {
      return String(input || "")
        .trim()
        .toLowerCase()
        .replace(/&/g, " and ")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .slice(0, 64);
    }

    function updateStoreLink(slug) {
      const href = `/partners/store.html?slug=${encodeURIComponent(slug)}`;
      linkPreviewEl.textContent = slug ? `${window.location.origin}${href}` : "";
      goConnectEl.href = `/partners/connect.html?slug=${encodeURIComponent(slug)}`;
      goConnectEl.style.display = slug ? "inline-flex" : "none";
    }

    nameEl.addEventListener("input", () => {
      updateStoreLink(slugify(nameEl.value));
    });

    async function createStore(partner) {
      const res = await fetch("/.netlify/functions/partner-save", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(partner),
      });

      const raw = await res.text();
      let data = null;
      try { data = JSON.parse(raw); } catch {}

      if (!res.ok) {
        if (res.status === 409) throw new Error("That store already exists. Ask us to invite you to it, or choose a different name.");
        throw new Error((data && (data.error || data.message)) || "Failed to create store");
      }
      return data;
    }

    document.getElementById("partner-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      setStatus("");

      const slug = slugify(nameEl.value);
      if (!slug) {
        alert("Enter a partner name.");
        return;
      }

      const partner = {
        createOnly: true,
        slug,
        name: nameEl.value.trim(),
        email: emailEl.value.trim(),
      };

      try {
        setStatus("Creating store...");
        const saved = await createStore(partner);
        updateStoreLink(saved.slug);
        setStatus(
          "Store created ✅\n\n" +
          `Slug: ${saved.slug}\n` +
          "Next: click “Continue to Stripe”.\n\n" +
          "Logo upload: after you sign in via magic link on Manage Store."
        );
      } catch (err) {
        console.error(err);
        setStatus(String(err && err.message ? err.message : err));
      }
    });

    // Initialize preview
    updateStoreLink("");
  </script>
</body>
</html>
