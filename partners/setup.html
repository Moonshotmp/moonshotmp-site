<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="canonical" href="https://moonshotmp.com/partners/setup.html" />
  <title>Partner Store Setup</title>
  <link rel="stylesheet" href="/partners/styles.css" />
</head>
<body>
  <section class="section section-dark bg-texture">
    <div class="container" style="max-width: 720px;">
      <h1>Partner Store Setup</h1>
      <p class="lead">Create your partner storefront first. Stripe connection happens on the next step.</p>

      <form id="partner-form" class="card" style="padding: 1.5rem;">
        <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">Business Information</h3>

        <label>
          Business name
          <input id="name" name="name" placeholder="e.g. Acme Wellness Clinic" required />
        </label>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <label>
            Contact name
            <input id="contactName" name="contactName" placeholder="Dr. Jane Smith" required />
          </label>
          <label>
            Phone number
            <input id="phone" name="phone" type="tel" placeholder="(555) 123-4567" required />
          </label>
        </div>

        <label>
          Contact email
          <input id="email" name="email" type="email" placeholder="jane@acmewellness.com" required />
        </label>

        <h3 style="margin: 1.5rem 0 1rem; font-size: 1.1rem;">Business Address</h3>

        <label>
          Street address
          <input id="street" name="street" placeholder="123 Main Street, Suite 100" required />
        </label>

        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem;">
          <label>
            City
            <input id="city" name="city" placeholder="Austin" required />
          </label>
          <label>
            State
            <input id="state" name="state" placeholder="TX" maxlength="2" required style="text-transform: uppercase;" />
          </label>
          <label>
            ZIP
            <input id="zip" name="zip" placeholder="78701" required />
          </label>
        </div>

        <h3 style="margin: 1.5rem 0 1rem; font-size: 1.1rem;">Logo <span style="font-weight: normal; opacity: 0.6;">(optional)</span></h3>

        <div style="display: flex; align-items: flex-start; gap: 1rem;">
          <div style="flex: 1;">
            <label style="margin-bottom: 0;">
              Upload your business logo
              <input id="logo" name="logo" type="file" accept="image/png, image/jpeg, image/gif, image/webp" style="padding: 0.75rem; background: rgba(255,255,255,0.05);" />
            </label>
            <div class="muted" style="margin-top: 0.5rem; font-size: 0.85rem;">
              Any image format. Will be automatically resized and compressed. You can also change this later.
            </div>
          </div>
          <div id="logo-preview" style="display: none; width: 80px; height: 80px; border-radius: 8px; overflow: hidden; background: rgba(255,255,255,0.1); flex-shrink: 0;">
            <img id="logo-preview-img" style="width: 100%; height: 100%; object-fit: contain;" alt="Logo preview" />
          </div>
        </div>

        <div style="margin-top: 1rem; opacity: 0.9;">
          Store link: <span id="store-link-preview"></span>
        </div>

        <div style="display:flex; gap: 10px; margin-top: 1.25rem; align-items:center;">
          <button type="submit" class="btn-primary">Create Store</button>
          <a id="go-connect" class="btn-outline" href="#" style="display:none;">Continue to Stripe</a>
        </div>

        <pre id="status" style="white-space:pre-wrap;margin-top:16px;"></pre>
      </form>
    </div>
  </section>

  <script>
    const statusEl = document.getElementById("status");
    const nameEl = document.getElementById("name");
    const contactNameEl = document.getElementById("contactName");
    const phoneEl = document.getElementById("phone");
    const emailEl = document.getElementById("email");
    const streetEl = document.getElementById("street");
    const cityEl = document.getElementById("city");
    const stateEl = document.getElementById("state");
    const zipEl = document.getElementById("zip");
    const linkPreviewEl = document.getElementById("store-link-preview");
    const goConnectEl = document.getElementById("go-connect");
    const logoEl = document.getElementById("logo");
    const logoPreviewEl = document.getElementById("logo-preview");
    const logoPreviewImg = document.getElementById("logo-preview-img");

    const MAX_INPUT_SIZE = 50 * 1024 * 1024; // 50MB input allowed
    const MAX_DIMENSION = 800; // Resize to max 800px
    const JPEG_QUALITY = 0.85;
    let logoDataUrl = null;

    function setStatus(msg) { statusEl.textContent = msg; }

    // Compress image using Canvas
    function compressImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();

        reader.onload = (e) => {
          img.onload = () => {
            // Calculate new dimensions
            let width = img.width;
            let height = img.height;

            if (width > MAX_DIMENSION || height > MAX_DIMENSION) {
              if (width > height) {
                height = Math.round((height * MAX_DIMENSION) / width);
                width = MAX_DIMENSION;
              } else {
                width = Math.round((width * MAX_DIMENSION) / height);
                height = MAX_DIMENSION;
              }
            }

            // Create canvas and draw resized image
            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");

            // Use white background for JPEGs (handles transparency)
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, width, height);
            ctx.drawImage(img, 0, 0, width, height);

            // Convert to JPEG (good compression, universal support)
            const compressedDataUrl = canvas.toDataURL("image/jpeg", JPEG_QUALITY);
            resolve(compressedDataUrl);
          };

          img.onerror = () => reject(new Error("Failed to load image"));
          img.src = e.target.result;
        };

        reader.onerror = () => reject(new Error("Failed to read file"));
        reader.readAsDataURL(file);
      });
    }

    // Handle logo file selection
    logoEl.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      logoDataUrl = null;
      logoPreviewEl.style.display = "none";

      if (!file) return;

      if (file.size > MAX_INPUT_SIZE) {
        alert("File is too large. Please select an image under 50MB.");
        logoEl.value = "";
        return;
      }

      if (!file.type.match(/^image\/(png|jpeg|gif|webp|bmp|tiff)$/)) {
        alert("Please select a valid image file.");
        logoEl.value = "";
        return;
      }

      try {
        setStatus("Compressing image...");
        logoDataUrl = await compressImage(file);
        logoPreviewImg.src = logoDataUrl;
        logoPreviewEl.style.display = "block";
        setStatus("");
      } catch (err) {
        alert("Failed to process image. Please try another file.");
        logoEl.value = "";
        setStatus("");
      }
    });

    function slugify(input) {
      return String(input || "")
        .trim()
        .toLowerCase()
        .replace(/&/g, " and ")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .slice(0, 64);
    }

    function updateStoreLink(slug) {
      const href = `/partners/store.html?slug=${encodeURIComponent(slug)}`;
      linkPreviewEl.textContent = slug ? `${window.location.origin}${href}` : "";
      goConnectEl.href = `/partners/connect.html?slug=${encodeURIComponent(slug)}`;
      goConnectEl.style.display = slug ? "inline-flex" : "none";
    }

    nameEl.addEventListener("input", () => {
      updateStoreLink(slugify(nameEl.value));
    });

    async function createStore(partner) {
      const res = await fetch("/.netlify/functions/partner-save", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(partner),
      });

      const raw = await res.text();
      let data = null;
      try { data = JSON.parse(raw); } catch {}

      if (!res.ok) {
        if (res.status === 409) throw new Error("That store already exists. Ask us to invite you to it, or choose a different name.");
        throw new Error((data && (data.error || data.message)) || "Failed to create store");
      }
      return data;
    }

    document.getElementById("partner-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      setStatus("");

      const slug = slugify(nameEl.value);
      if (!slug) {
        alert("Enter a partner name.");
        return;
      }

      const partner = {
        createOnly: true,
        slug,
        name: nameEl.value.trim(),
        contactName: contactNameEl.value.trim(),
        phone: phoneEl.value.trim(),
        email: emailEl.value.trim(),
        address: {
          street: streetEl.value.trim(),
          city: cityEl.value.trim(),
          state: stateEl.value.trim().toUpperCase(),
          zip: zipEl.value.trim(),
        },
      };

      // Include logo if one was selected
      if (logoDataUrl) {
        partner.logoDataUrl = logoDataUrl;
      }

      try {
        setStatus("Creating store...");
        const saved = await createStore(partner);
        updateStoreLink(saved.slug);
        setStatus(
          "Store created âœ…\n\n" +
          `Slug: ${saved.slug}\n` +
          "Next: click "Continue to Stripe"."
        );
      } catch (err) {
        console.error(err);
        setStatus(String(err && err.message ? err.message : err));
      }
    });

    // Initialize preview
    updateStoreLink("");
  </script>
</body>
</html>
