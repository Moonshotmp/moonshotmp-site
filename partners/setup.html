<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Partner Store Setup</title>
  <link rel="stylesheet" href="/partners/styles.css" />
</head>
<body>
  <section class="section section-dark bg-texture">
    <div class="container" style="max-width: 720px;">
      <h1>Partner Store Setup</h1>
      <p class="lead">Create your partner storefront first. Stripe connection happens on the next step.</p>

      <form id="partner-form" class="card" style="padding: 1.5rem;">
        <label>
          Partner name
          <input id="name" name="name" placeholder="e.g. Acme Co" required />
        </label>

        <label>
          Contact email
          <input id="email" name="email" type="email" placeholder="name@acme.com" />
        </label>

        <div style="margin-top: 1rem;">
          <div class="muted" style="margin-bottom: 0.5rem;">Logo (optional)</div>
          <input id="logo" type="file" accept="image/*" />
          <div class="muted" style="margin-top: 0.5rem;">We’ll auto-resize large images so they display cleanly.</div>

          <div id="logo-preview-wrap" style="display:none; margin-top: 1rem;">
            <div class="muted" style="margin-bottom: 0.5rem;">Preview</div>
            <div style="height: 120px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.03);">
              <img id="logo-preview" alt="Logo preview" style="max-height: 80px; max-width: 80%; object-fit: contain;" />
            </div>
          </div>
        </div>

        <div style="margin-top: 1rem; opacity: 0.9;">
          Store link: <span id="store-link-preview"></span>
        </div>

        <div style="display:flex; gap: 10px; margin-top: 1.25rem; align-items:center;">
          <button type="submit" class="btn-primary">Create Store</button>
          <a id="go-connect" class="btn-outline" href="#" style="display:none;">Continue to Stripe</a>
        </div>

        <pre id="status" style="white-space:pre-wrap;margin-top:16px;"></pre>
      </form>
    </div>
  </section>

  <script>
    const statusEl = document.getElementById("status");
    const nameEl = document.getElementById("name");
    const emailEl = document.getElementById("email");
    const logoEl = document.getElementById("logo");
    const previewWrapEl = document.getElementById("logo-preview-wrap");
    const previewImgEl = document.getElementById("logo-preview");
    const linkPreviewEl = document.getElementById("store-link-preview");
    const goConnectEl = document.getElementById("go-connect");

    function setStatus(msg) { statusEl.textContent = msg; }

    function slugify(input) {
      return String(input || "")
        .trim()
        .toLowerCase()
        .replace(/&/g, " and ")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .slice(0, 64);
    }

    function updateStoreLink(slug) {
      const href = `/partners/store.html?slug=${encodeURIComponent(slug)}`;
      linkPreviewEl.textContent = slug ? `${window.location.origin}${href}` : "";
      goConnectEl.href = `/partners/connect.html?slug=${encodeURIComponent(slug)}`;
      goConnectEl.style.display = slug ? "inline-flex" : "none";
    }

    async function resizeImageToDataUrl(file, maxW = 600, maxH = 240, quality = 0.86) {
      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.onload = () => resolve(i);
        i.onerror = reject;
        i.src = URL.createObjectURL(file);
      });

      const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
      const w = Math.round(img.width * ratio);
      const h = Math.round(img.height * ratio);

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, w, h);
      ctx.drawImage(img, 0, 0, w, h);

      // Use JPEG for smaller payload unless source has transparency needs
      const mime = "image/jpeg";
      const dataUrl = canvas.toDataURL(mime, quality);

      return { dataUrl, mime, width: w, height: h };
    }

    let logoData = null;

    logoEl.addEventListener("change", async () => {
      setStatus("");
      logoData = null;

      const file = logoEl.files && logoEl.files[0];
      if (!file) {
        previewWrapEl.style.display = "none";
        return;
      }

      // Simple size guard (keeps blobs sane)
      if (file.size > 3 * 1024 * 1024) {
        alert("Logo file too large. Please use an image under 3MB.");
        logoEl.value = "";
        previewWrapEl.style.display = "none";
        return;
      }

      try {
        logoData = await resizeImageToDataUrl(file);
        previewImgEl.src = logoData.dataUrl;
        previewWrapEl.style.display = "block";
      } catch (e) {
        console.error(e);
        alert("Could not process that image. Try a different file.");
        logoEl.value = "";
        previewWrapEl.style.display = "none";
      }
    });

    nameEl.addEventListener("input", () => {
      updateStoreLink(slugify(nameEl.value));
    });

    async function createStore(partner) {
      const res = await fetch("/.netlify/functions/partner-save", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(partner),
      });

      const raw = await res.text();
      let data = null;
      try { data = JSON.parse(raw); } catch {}

      if (!res.ok) {
        if (res.status === 409) throw new Error("That store already exists. Ask us to invite you to it, or choose a different name.");
        throw new Error((data && (data.error || data.message)) || "Failed to create store");
      }
      return data;
    }

    document.getElementById("partner-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      setStatus("");

      const slug = slugify(nameEl.value);
      if (!slug) {
        alert("Enter a partner name.");
        return;
      }

      const partner = {
        createOnly: true,
        slug,
        name: nameEl.value.trim(),
        email: emailEl.value.trim(),
        branding: logoData ? { logoDataUrl: logoData.dataUrl, logoMime: logoData.mime } : undefined,
      };

      try {
        const saved = await createStore(partner);
        updateStoreLink(saved.slug);
        setStatus("Store created ✅  Redirecting to Stripe connection…");
        window.location.href = `/partners/connect.html?slug=${encodeURIComponent(saved.slug)}`;
      } catch (err) {
        setStatus(String(err?.message || err));
        alert(err?.message || String(err));
      }
    });

    // initialize preview
    updateStoreLink("");
  </script>
</body>
</html>
