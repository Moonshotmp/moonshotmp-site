<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage Store</title>
  <link rel="stylesheet" href="/partners/styles.css" />
  <style>
    .muted { opacity: 0.8; }
    .row { display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end; }
    .col { display:flex; flex-direction:column; gap:6px; }
    .pill { display:inline-flex; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); font-size:12px; }
    .status { white-space: pre-wrap; margin-top: 12px; }
    .thumb { height:64px; width:64px; border-radius:12px; border:1px solid rgba(255,255,255,0.14); object-fit:contain; background: rgba(255,255,255,0.06); }
    .toast { display:none; padding:12px 14px; margin:12px 0; border:1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); }
  </style>
</head>
<body>
  <main class="container" style="max-width:900px;">
    <h1>Manage Store</h1>
    <p class="muted" id="subtitle" style="margin-top:-6px;">Loading…</p>

    <div id="verifiedToast" class="toast">✅ Signed in. You can manage your store below.</div>

    <div id="panel" class="card" style="padding:1.25rem; display:none;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="pill" id="stripeBadge">Stripe: …</div>
        <div class="pill" id="storeIdPill">Store ID: …</div>
      </div>

      <div class="row" style="margin-top:14px;">
        <div class="col">
          <div class="muted" style="font-size:12px;">Logo / Picture</div>
          <img id="logoPreview" class="thumb" alt="Logo preview" />
          <input id="logoInput" type="file" accept="image/*" />
          <div class="muted" style="font-size:12px; max-width:320px;">
            Upload a square-ish logo. We store it as a data URL in the partner record (simple + works everywhere).
          </div>
        </div>

        <div style="flex:1; min-width:280px;">
          <div class="row">
            <label class="col" style="min-width:280px; flex:1;">
              Partner name
              <input id="name" />
            </label>

            <label class="col" style="min-width:280px; flex:1;">
              Contact email
              <input id="email" type="email" />
            </label>
          </div>

          <div style="margin-top:12px;">
            <div class="muted" style="font-size:12px;">Store URL</div>
            <div class="pill" style="user-select:all;" id="storeUrl"></div>
          </div>

          <div class="row" style="margin-top:14px;">
            <button class="btn-primary" id="saveBtn">Save changes</button>
            <a class="btn-outline" id="viewStore" href="#">View store</a>
            <a class="btn-outline" id="connectStripe" href="#">Connect / Manage Stripe</a>
            <button class="btn-outline" id="resetStripeBtn" style="display:none;">Reset Stripe</button>
            <button class="btn-outline" id="logoutBtn">Sign out</button>
          </div>

          <pre id="status" class="status"></pre>
        </div>
      </div>
    </div>
  </main>

<script>
  const qs = new URL(window.location.href).searchParams;
  const slugHint = (qs.get("slug") || "").trim().toLowerCase();

  // show verified toast once
  if (qs.get("verified") === "1") {
    const toast = document.getElementById("verifiedToast");
    toast.style.display = "block";
    const url = new URL(window.location.href);
    url.searchParams.delete("verified");
    window.history.replaceState({}, "", url.toString());
  }

  const subtitle = document.getElementById("subtitle");
  const panel = document.getElementById("panel");
  const statusEl = document.getElementById("status");

  const stripeBadge = document.getElementById("stripeBadge");
  const storeIdPill = document.getElementById("storeIdPill");
  const storeUrlEl = document.getElementById("storeUrl");

  const logoPreview = document.getElementById("logoPreview");
  const logoInput = document.getElementById("logoInput");

  const nameEl = document.getElementById("name");
  const emailEl = document.getElementById("email");

  const viewStore = document.getElementById("viewStore");
  const connectStripe = document.getElementById("connectStripe");

  let currentSlug = null;
  let currentPartner = null;
  let pendingLogoDataUrl = null;

  function setStatus(msg){ statusEl.textContent = msg || ""; }

  async function loadMe() {
    const res = await fetch("/.netlify/functions/partner-me");
    if (!res.ok) return null;
    const data = await res.json();
    return data.partner || null;
  }

  function toDataURL(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  function setStripeBadge(p) {
    const connected = !!p?.stripe?.connectedAccountId;
    const onboarded = !!p?.stripe?.onboarded;
    stripeBadge.textContent = !connected ? "Stripe: not connected"
      : (onboarded ? "Stripe: connected ✅" : "Stripe: setup incomplete ⚠️");
  }

  function showPanel(p) {
    currentPartner = p;
    currentSlug = (p.slug || slugHint || "").trim().toLowerCase();

    subtitle.textContent = `Signed in as ${p.email || ""}`;
    panel.style.display = "block";

    setStripeBadge(p);
    storeIdPill.textContent = `Store ID: ${currentSlug || "—"}`;

    const storeUrl = `${window.location.origin}/partners/store.html?slug=${encodeURIComponent(currentSlug)}`;
    storeUrlEl.textContent = storeUrl;

    nameEl.value = p.name || "";
    emailEl.value = p.email || "";

    const logo = p?.branding?.logoDataUrl || "";
    logoPreview.src = logo || "data:image/gif;base64,R0lGODlhAQABAAAAACw=";

    viewStore.href = `/partners/store.html?slug=${encodeURIComponent(currentSlug)}`;
    connectStripe.href = `/partners/connect.html?slug=${encodeURIComponent(currentSlug)}`;
  }

  async function save() {
    setStatus("Saving…");
    const payload = {
      name: nameEl.value.trim(),
      email: emailEl.value.trim(),
      branding: {}
    };
    if (pendingLogoDataUrl) payload.branding.logoDataUrl = pendingLogoDataUrl;

    const res = await fetch("/.netlify/functions/partner-update", {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(payload)
    });

    const raw = await res.text();
    let data = null; try { data = JSON.parse(raw); } catch {}

    if (!res.ok) {
      setStatus((data && (data.error || data.message)) || "Save failed");
      return;
    }

    setStatus("Saved ✅");
    pendingLogoDataUrl = null;

    // reload partner to reflect updates
    const p = await loadMe();
    if (p) showPanel(p);
  }

  async function resetStripe() {
    setStatus("Resetting Stripe…");
    const res = await fetch("/.netlify/functions/stripe-reset", { method: "POST" });
    const raw = await res.text();
    let data = null; try { data = JSON.parse(raw); } catch {}

    if (!res.ok) {
      setStatus((data && (data.error || data.message)) || "Reset failed");
      return;
    }

    setStatus("Stripe reset ✅");
    const p = await loadMe();
    if (p) showPanel(p);
  }

  async function logout() {
    await fetch("/.netlify/functions/auth-logout", { method: "POST" });
    const next = `/partners/login.html${currentSlug ? `?slug=${encodeURIComponent(currentSlug)}` : ""}`;
    window.location.href = next;
  }

  logoInput.addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    pendingLogoDataUrl = await toDataURL(f);
    logoPreview.src = pendingLogoDataUrl;
    setStatus("Logo ready — click Save changes to apply.");
  });

  document.getElementById("saveBtn").addEventListener("click", save);
  document.getElementById("resetStripeBtn").addEventListener("click", resetStripe);
  document.getElementById("logoutBtn").addEventListener("click", logout);

  (async () => {
    const p = await loadMe();
    if (!p) {
      // Not signed in → send to login, preserving slug if we have it
      const target = `/partners/login.html${slugHint ? `?slug=${encodeURIComponent(slugHint)}` : ""}`;
      window.location.href = target;
      return;
    }
    showPanel(p);
  })();
</script>
</body>
</html>
