<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage Store</title>
  <link rel="stylesheet" href="/partners/styles.css" />
  <style>
    .muted { opacity: 0.8; }
    .inline-note { font-size: 13px; opacity: 0.85; margin-top: 10px; }
    .status { white-space: pre-wrap; margin-top: 14px; }

    /* Button micro-UX */
    .btn-content { display:inline-flex; align-items:center; gap:10px; justify-content:center; }
    .spinner { width:14px; height:14px; border:2px solid rgba(255,255,255,0.35); border-top-color:#fff; border-radius:999px; animation:spin 0.8s linear infinite; display:none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      background: rgba(20, 20, 20, 0.96);
      color: white;
      padding: 12px 14px;
      border-radius: 10px;
      font-size: 14px;
      max-width: min(560px, calc(100vw - 32px));
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 180ms ease, transform 180ms ease;
      z-index: 9999;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(-4px); }
    .toast small { display:block; opacity:0.8; margin-top:4px; }
  </style>

  <style data-noflicker>
    html { visibility: hidden; }
    html.ready { visibility: visible; }
  </style>
</head>


<body>
  <header class="topbar">
    <a href="/partners/index.html" class="brand">Moonshot Partners</a>
    <nav class="nav">
      <a href="/partners/index.html">Partners</a>
      <a href="/partners/store.html">Storefront</a>
      <a href="/partners/manage.html" class="active">Manage</a>
    </nav>
  </header>

  <main class="container">
    <h1>Partner Login + Store Manager</h1>
    <p class="muted">
      Enter your Store ID (slug) and the email that matches the partner record.
      We’ll email you a sign-in link if it matches.
    </p>

    <section class="card" id="login">
      <h2>Sign in</h2>

      <div class="grid-2">
        <label>
          <div>Store ID (slug)</div>
          <input id="slug" placeholder="tommy-k-fitness" />
        </label>

        <label>
          <div>Email</div>
          <input id="email" type="email" placeholder="you@domain.com" />
        </label>
      </div>

      <div style="margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button id="sendLink" class="btn primary">
          <span class="btn-content">
            <span class="spinner" id="spinner"></span>
            <span id="btnText">Email sign-in link</span>
          </span>
        </button>
        <span class="inline-note">
          Tip: for inline link on this page, add <code>&amp;dev=1</code> to the URL and enable echo server-side.
        </span>
      </div>

      <div class="inline-note">
        <div><strong>Dev link (only appears if server returns it):</strong></div>
        <pre id="devLink" style="margin-top:8px; padding:10px; border-radius:8px; background:#0b1020; color:#e6e6ff; overflow:auto;"></pre>
      </div>

      <pre id="status" class="status"></pre>
    </section>

    <section class="card" id="manage" style="display:none;">
      <h2>Manage your store</h2>
      <p class="muted">You’re signed in. Update your details below.</p>

      <div id="stripeStatus" class="inline-note"></div>

      <div class="grid-2" style="margin-top:14px;">
        <label>
          <div>Store Name</div>
          <input id="storeName" />
        </label>

        <label>
          <div>Email</div>
          <input id="storeEmail" type="email" />
        </label>
      </div>

      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
        <button id="save" class="btn primary">Save</button>
        <button id="resetStripe" class="btn">Reset Stripe</button>
      </div>

      <pre id="manageStatus" class="status"></pre>
    </section>
  </main>

  <div class="toast" id="toast"></div>

<script>
  document.documentElement.classList.add('ready');

  const qs = new URL(window.location.href).searchParams;
  const DEV = qs.get("dev") === "1";

  const loginEl = document.getElementById("login");
  const manageEl = document.getElementById("manage");

  const slugEl = document.getElementById("slug");
  const emailEl = document.getElementById("email");

  const sendBtn = document.getElementById("sendLink");
  const spinner = document.getElementById("spinner");
  const btnText = document.getElementById("btnText");
  const devLinkEl = document.getElementById("devLink");
  const statusEl = document.getElementById("status");

  const storeNameEl = document.getElementById("storeName");
  const storeEmailEl = document.getElementById("storeEmail");
  const stripeStatusEl = document.getElementById("stripeStatus");
  const saveBtn = document.getElementById("save");
  const resetStripeBtn = document.getElementById("resetStripe");
  const manageStatusEl = document.getElementById("manageStatus");

  const toastEl = document.getElementById("toast");

  const EMAIL_KEY = "ms_partner_email";

  function setStatus(msg) { statusEl.textContent = msg || ""; }
  function setManageStatus(msg) { manageStatusEl.textContent = msg || ""; }

  function toast(msg, sub) {
    toastEl.innerHTML = "";
    toastEl.textContent = msg;
    if (sub) {
      const s = document.createElement("small");
      s.textContent = sub;
      toastEl.appendChild(s);
    }
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 2600);
  }

  function setSending(isSending) {
    spinner.style.display = isSending ? "inline-block" : "none";
    btnText.textContent = isSending ? "Sending..." : "Email sign-in link";
    sendBtn.disabled = isSending;
  }

  function flashSent() {
    toast("✅ Sign-in link sent", "Check your inbox (and spam).");
  }

  function cleanParamOnce(key) {
    if (!qs.has(key)) return;
    const url = new URL(window.location.href);
    url.searchParams.delete(key);
    history.replaceState({}, "", url.toString());
  }

  // Pull slug from URL if present
  const urlSlug = qs.get("slug");
  if (urlSlug) slugEl.value = urlSlug;

  // Prefill email from storage
  const savedEmail = localStorage.getItem(EMAIL_KEY);
  if (savedEmail && !emailEl.value) emailEl.value = savedEmail;

  // Verified toast (one-time)
  if (qs.get("verified") === "1") {
    toast("✅ Signed in.", "You can manage your store below.");
    cleanParamOnce("verified");
  }

  async function requestLink() {
    devLinkEl.textContent = "";
    setStatus("");

    const slug = String(slugEl.value || "").trim();
    const email = String(emailEl.value || "").trim();

    if (!slug || !email) {
      setStatus("Enter Store ID + Email.");
      return;
    }

    setSending(true);

    try {
      const res = await fetch("/.netlify/functions/auth-request", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ slug, email, dev: DEV })
      });

      const raw = await res.text();
      let data = null;
      try { data = JSON.parse(raw); } catch {}

      localStorage.setItem(EMAIL_KEY, email);

      if (!res.ok) {
        setStatus((data && (data.error || data.message)) || "Request failed");
        return;
      }

      flashSent();

      if (data?.link) {
        devLinkEl.textContent = data.link;
        setStatus("Dev mode: open the link above to sign in.");
      } else {
        setStatus(
          DEV
            ? "Dev mode is ON, but the server did not return a link. (In production we do not echo magic links.)"
            : "If the email matches the store owner email, you’ll receive a sign-in link."
        );
      }
    } finally {
      setSending(false);
    }
  }

  sendBtn.addEventListener("click", (e) => {
    e.preventDefault();
    requestLink();
  });

  async function loadMe() {
    try {
      const res = await fetch("/.netlify/functions/partner-me", { cache: "no-store" });
      const data = await res.json().catch(() => null);
      if (!res.ok || !data?.partner) return false;

      // show manage UI
      loginEl.style.display = "none";
      manageEl.style.display = "block";

      const p = data.partner;
      storeNameEl.value = p?.name || "";
      storeEmailEl.value = p?.email || "";

      const connected = !!p?.stripe?.connectedAccountId;
      const onboarded = !!p?.stripe?.onboarded || !!p?.stripe?.detailsSubmitted;

      stripeStatusEl.textContent = connected
        ? (onboarded ? "Stripe: Connected ✅" : "Stripe: Connected (onboarding incomplete)")
        : "Stripe: Not connected";

      return true;
    } catch (err) {
      return false;
    }
  }

  async function save() {
    setManageStatus("");
    const name = String(storeNameEl.value || "").trim();
    const email = String(storeEmailEl.value || "").trim();
    try {
      const res = await fetch("/.netlify/functions/partner-update", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ name, email })
      });
      const data = await res.json().catch(() => null);
      if (!res.ok) {
        setManageStatus((data && (data.error || data.message)) || "Save failed");
        return;
      }
      toast("✅ Saved", "Your store details were updated.");
      setManageStatus("Saved.");
    } catch (e) {
      setManageStatus("Save failed.");
    }
  }

  async function resetStripe() {
    setManageStatus("");
    try {
      const res = await fetch("/.netlify/functions/stripe-reset", { method: "POST" });
      const data = await res.json().catch(() => null);
      if (!res.ok) {
        setManageStatus((data && (data.error || data.message)) || "Reset failed");
        return;
      }
      toast("✅ Stripe reset", "You can reconnect Stripe from setup.");
      setManageStatus("Stripe reset.");
      // reload state
      await loadMe();
    } catch {
      setManageStatus("Reset failed.");
    }
  }

  saveBtn.addEventListener("click", (e) => { e.preventDefault(); save(); });
  resetStripeBtn.addEventListener("click", (e) => { e.preventDefault(); resetStripe(); });

  // Try to load session on page load
  loadMe();
</script>
</body>
</html>
